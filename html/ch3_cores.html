<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>urbit_tutorial</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js"],
          equationNumbers: {
            autoNumber: "AMS",
            formatNumber: function (n) { return "5" + '.' + n }
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            sig: "\\textasciitilde",
ket: "\\verb+^+",
phep: "\\kode{-{}-}"
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null
      });

      </script>
      <script type="text/javascript" src="MathJax/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="cid16" data-tralics-id="cid16" class="chapter" data-number="5" data-chapter="ch3_cores"><h1><a href="ch3_cores_fragment.html#cid16" class="heading hyperref"><span class="number">Chapter 5 </span>Cores and Gates</a></h1>
<blockquote class="quotation"><p class="noindent"><em>But are you crazy enough?</em></p>
<p style="margin-top: 6.0pt"><span class="break"></span>
—<strong>Point Break</strong></p>
</blockquote></div>
<div id="cid17" data-tralics-id="cid17" class="section" data-number="5.1"><h2><a href="ch3_cores_fragment.html#cid17" class="heading hyperref"><span class="number">5.1 </span>Playing with Nock</a></h2>
<p>Now we’re going to actually do some cool stuff with Nock.</p>
<p>Fortunately, we have an entire OS, Arvo, which is built on Nock.<span class="intersentencespace"></span> Unfortunately, there’s really no practical reason to work
directly in Nock when you’re using Arvo - except for learning
Nock, which you do once and never again.<span class="intersentencespace"></span> So the things we’ll
have to do are a little bit cumbersome.</p>
<p>What Arvo is good at is evaluating Hoon.<span class="intersentencespace"></span> And it’s possible to
evaluate Nock from Hoon, much the way you can put inline assembly
in C. Through this indirection, we have two ways to run Nock in
Hoon: on the command line and via an app file.</p>
<div id="uid39" data-tralics-id="uid39" class="subsection" data-number="5.1.1"><h3><a href="ch3_cores_fragment.html#uid39" class="heading hyperref"><span class="number">5.1.1 </span>Command line</a></h3>
<p>From the Arvo command line, you can run one-liners with the Hoon
rune <code>.*</code>:</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; .*(42 [4 0 1])
43
</pre></div></div>
</div>
<div id="uid40" data-tralics-id="uid40" class="subsection" data-number="5.1.2"><h3><a href="ch3_cores_fragment.html#uid40" class="heading hyperref"><span class="number">5.1.2 </span>Application file</a></h3>
<p>Unfortunately, the Arvo command line doesn’t do multiline input
well, and if there’s any hope of writing complex Nock formulas
it’s by using plenty of whitespace and linebreaks.</p>
<p>So we’ve constructed a template for writing Nock formulas as Arvo
applications.<span class="intersentencespace"></span> Unfortunately Arvo is a young OS and has no way to
edit a file.<span class="intersentencespace"></span> But Arvo runs on Unix and Unix is a very old OS.
Arvo syncs its filesystem with your <code>$URBIT_HOME</code> directory,
propagating changes on either side.</p>
<p>Let’s assume your <code>$URBIT_HOME</code> is <code>urb/</code>, and your ship is
<code><span class="inline_math">\( \sim  \)</span>tomsyt-balsen</code>.<span class="intersentencespace"></span> The Nock application template is in</p>
<div class="code"><div class="highlight"><pre>urb/tomsyt-balsen/try/bin/nock.hoon
</pre></div></div>
<p>Its text should be:</p>
<div class="code"><div class="highlight"><pre>!:             ::  To write Nock as an Arvo application in Hoon
|=  *          ::
|=  [a=* ~]    ::  For educational purposes only
:_  ~  :_  ~   ::
:-  %la        ::  Preserve this mysterious boilerplate square
%+  sell  %noun::
.*  a          ::  Replace the formula with your own
:::::::::::::::::
               ::  Formula: increment
[4 0 1]
</pre></div></div>
<p>For the rest of this document we’ll simply assume you can copy
boilerplate, and write the rest of the file:</p>
<div class="code"><div class="highlight"><pre>[4 0 1]                                      ::    bump /1
</pre></div></div>
<p>(The pseudocode in the comments is not in any way described.<span class="intersentencespace"></span> If
you have trouble figuring it out, that’s okay, because it should
make itself obvious by the end of the document.)</p>
<p>Test this by running:</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; :nock 42
43
</pre></div></div>
<p>Our first complex example will be a decrement function.<span class="intersentencespace"></span> With or
without <code>vere</code> running, copy the template from Unix:</p>
<div class="code"><div class="highlight"><pre>$ cp urb/tomsyt-balsen/try/bin/nock.hoon urb/tomsyt-balsen/try/bin/dec.hoon
</pre></div></div>
<p>Then, use a Unix editor to change “Formula: increment” to
“Formula: decrement” in <code>dec.hoon</code>.</p>
<p>Either next time you start <code>vere</code>, or on your next keyboard event
if you’re already running it, you’ll see something like</p>
<div class="code"><div class="highlight"><pre> + /~tomsyt-balsen/try/1/bin/dec/hoon
</pre></div></div>
<p>Arvo has slurped up dec.hoon from your filesystem.<span class="intersentencespace"></span> To test it,</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; :dec 42
43
</pre></div></div>
<p>Well, we didn’t change the formula, so it still increments.<span class="intersentencespace"></span> But
it’s a start.</p>
</div></div>
<div id="cid18" data-tralics-id="cid18" class="section" data-number="5.2"><h2><a href="ch3_cores_fragment.html#cid18" class="heading hyperref"><span class="number">5.2 </span>Decrement</a></h2>
<p>The only arithmetic operation in Nock is increment.<span class="intersentencespace"></span> So how do we
decrement?<span class="intersentencespace"></span> The algorithm is obvious: to decrement <code>n</code>, start
from <code>0</code>, and count up to <code>n-1</code>.<span class="intersentencespace"></span> Or rather, count up to a number
<code>m</code> such that <code>m+1</code> equals <code>n</code>.</p>
<p>(Is this going to be an <code>O(n)</code> algorithm?<span class="intersentencespace"></span> It is.<span class="intersentencespace"></span> How do we
compute effectively in a platform where decrement is <code>O(n)</code>?<span class="intersentencespace"></span> Gosh, it seems difficult, doesn’t it?<span class="intersentencespace"></span> We’ll get to that.)</p>
<p>The first thing we’re going to need is a counter.<span class="intersentencespace"></span> Right now
our subject is just the atom we’re trying to decrement - <code>/1</code>,
referenced with the formula <code>[0 1]</code>.<span class="intersentencespace"></span> Thus, to increment it,
the formula is <code>[4 0 1]</code>.</p>
<p>Let’s try to put the counter into the subject with one of our
macros operators, <code>8</code>.<span class="intersentencespace"></span> Recall our revised rule for <code>8</code>:</p>
<div class="code"><div class="highlight"><pre>34r::    *[a 8 b c]       *[[*[a b] a] c]
</pre></div></div>
<p>The formula <code>c</code> is applied to the subject <code>[*[a b] a]</code>.<span class="intersentencespace"></span> What is
our <code>b</code>?<span class="intersentencespace"></span> It should just produce our initial counter value - 0.<span class="intersentencespace"></span> So, use operator <code>1</code> to produce a constant - <code>[1 0]</code>.<span class="intersentencespace"></span> Let’s
put this counter in the subject, and then increment as usual.</p>
<p>Edit <code>dec.hoon</code> so that the formula reads</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [4 0 1]                                    ::  bump /1
]                                            ::
</pre></div></div>
<p>Note that for these tall bracket structures, the space after <code>[</code>
is essential.<span class="intersentencespace"></span> Then, you’ll see the file automatically update in
Arvo:</p>
<div class="code"><div class="highlight"><pre>: /~tomsyt-balsen/try/2/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
</pre></div></div>
<p>Whoops!<span class="intersentencespace"></span> It crashed:</p>
<div class="code"><div class="highlight"><pre>! /~tomsyt-balsen/try/~2013.11.26..00.01.38..499b/bin/dec/:&lt;[4 1].[13 2]&gt;
! /~tomsyt-balsen/try/~2013.11.26..00.01.38..499b/bin/dec/:&lt;[4 8].[13 2]&gt;
! /~tomsyt-balsen/try/~2013.11.26..00.01.38..499b/bin/dec/:&lt;[5 1].[13 2]&gt;
! /~tomsyt-balsen/try/~2013.11.26..00.01.38..499b/bin/dec/:&lt;[6 1].[13 2]&gt;
! /~tomsyt-balsen/try/~2013.11.26..00.01.38..499b/bin/dec/:&lt;[7 1].[13 2]&gt;
! exit
</pre></div></div>
<p>What did we do wrong?<span class="intersentencespace"></span> We forgot that the subject had changed.<span class="intersentencespace"></span> When we get to <code>[4 0 1]</code>, the subject is not <code>42</code>, but <code>[0 42]</code> -
the counter is there.<span class="intersentencespace"></span> So our original argument, <code>42</code>, is
actually at <code>/3</code>:</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [4 0 3]                                    ::  bump /3
]                                            ::

: /~tomsyt-balsen/try/3/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
43
</pre></div></div>
<p>Okay, at least it increments again.<span class="intersentencespace"></span> (Constantly readjusting tree
addresses by hand is one good reason to use a higher-level
language, like Hoon.)<span class="intersentencespace"></span> But now, perhaps, we can build a decrement
that works for at least one input value - <code>1</code>.</p>
<p>Obviously at some point we’ll have to build a loop.<span class="intersentencespace"></span> But for now,
all we need is an <code>if</code> statement that compares the incremented
counter to the original argument.<span class="intersentencespace"></span> We know the original argument
is at <code>/3</code>, and the counter is at <code>/2</code>; we use the if operator,
<code>6</code>, and the equality test operator <code>5</code>.<span class="intersentencespace"></span> If the comparison
fails, we shrug our shoulders and keep incrementing the argument.</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [ 6                                        ::  pick
    [5 [4 0 2] [0 3]]                        ::  same (bump /2) /3
    [0 2]                                    ::  /2
    [4 0 3]                                  ::  bump /3
  ]                                          :: 
]                                            :: 

: /~tomsyt-balsen/try/4/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
43
~tomsyt-balsen/try=&gt; :dec 1
0
</pre></div></div>
<p>We’re getting closer.<span class="intersentencespace"></span> But now, that loop:</p>
<p>Up till now, our subject has contained only data.<span class="intersentencespace"></span> If we want to
loop, we’re obviously going to have to bite the bullet and put
code in our subject - which will become a <code>[code data]</code> cell.<span class="intersentencespace"></span> In Nock (and Hoon) this is called a <code>core</code>.</p>
<p>Suppose we take our <code>6</code> formula and put it in the subject.<span class="intersentencespace"></span> Then,
with this core subject <code>[formula counter argument]</code>, we’ll run
the formula itself.<span class="intersentencespace"></span> With this subject, the formula is <code>/2</code>, and
of course the core itself is <code>/1</code>.<span class="intersentencespace"></span> So we can activate the core
with <code>[2 [0 1] [0 2]]</code>.</p>
<p>Of course, since the subject has changed again, we need to change
the addresses again.<span class="intersentencespace"></span> The counter is now <code>/6</code> and the argument
is now <code>/7</code>:</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [ 8                                        ::  push
    [ 1                                      ::  quid
      [ 6                                    ::  pick
        [5 [4 0 6] [0 7]]                    ::  same (bump /6) /7
        [0 6]                                ::  /6
        [4 0 7]                              ::  bump /7
      ]                                      :: 
    ]                                        :: 
    [2 [0 1] [0 2]]                          ::  nock /1 /2
  ]                                          :: 
]                                            :: 
</pre></div></div>
<p>This does exactly the same thing as before:</p>
<div class="code"><div class="highlight"><pre>: /~tomsyt-balsen/try/5/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
43
~tomsyt-balsen/try=&gt; :dec 1
0
</pre></div></div>
<p>But somehow, we feel it <em>could</em> do better.<span class="intersentencespace"></span> Why?<span class="intersentencespace"></span> Because where
we do the useless <code>[4 0 7]</code>, we have a subject containing the
code we want to invoke.<span class="intersentencespace"></span> It’s just that the counter is wrong.</p>
<p>We need to do the same thing as <code>[2 [0 1] [0 2]</code>, but the subject
is not <code>[0 1]</code>.<span class="intersentencespace"></span> That would be <code>[formula counter argument]</code>.<span class="intersentencespace"></span> We
need <code>[formula (counter + 1) argument]</code>.</p>
<p>So, <code>formula</code> is <code>[0 2]</code>, <code>counter</code> is <code>[0 6]</code>, and <code>argument</code> is
<code>[0 7]</code>.<span class="intersentencespace"></span> With autocons, we can just put them together to make a
(superfluous) formula for <code>[formula counter argument]</code> - ie,</p>
<div class="code"><div class="highlight"><pre>[[0 2] [0 6] [0 7]]               ::  cons /2 /6 /7
</pre></div></div>
<p>But we actually want to increment the counter:</p>
<div class="code"><div class="highlight"><pre>[[0 2] [4 0 6] [0 7]]             ::  cons /2 (bump /6) /7
</pre></div></div>
<p>And to invoke our formula on this modified core:</p>
<div class="code"><div class="highlight"><pre>[2 [[0 2] [4 0 6] [0 7]] [0 2]]   ::  nock (cons /2 (bump /6) /7) /2
</pre></div></div>
<p>If we put this into the decrement, it should actually work:</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [ 8                                        ::  push
    [ 1                                      ::  quid
      [ 6                                    ::  pick
        [5 [4 0 6] [0 7]]                    ::  same (bump /6) /7
        [0 6]                                ::  /6
        [ 2                                  ::  nock
           [[0 2] [4 0 6] [0 7]]             ::  (cons /2 (bump /6) /7)
           [0 2]                             ::  /2
        ]                                    ::
      ]                                      ::
    ]                                        ::
    [2 [0 1] [0 2]]                          ::  nock /1 /2
  ]                                          ::
]                                            ::
</pre></div></div>
<p>And it does:</p>
<div class="code"><div class="highlight"><pre>: /~tomsyt-balsen/try/6/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
41
</pre></div></div>
<p>But there’s one more step.<span class="intersentencespace"></span> Remember operator <code>9</code>?</p>
<div class="code"><div class="highlight"><pre>35 ::    *[a 9 b c]       *[a 7 c 2 [0 1] 0 b]
35r::    *[a 9 b c]       *[*[a c] *[*[a c] 0 b]]
</pre></div></div>
<p>Suppose <code>c</code> is a formula that produces a core.<span class="intersentencespace"></span> Then we see
immediately what <code>9</code> does: it activates a core, using the formula
at <code>/b</code> within the core.</p>
<p>So we can rewrite our decrement to use <code>9</code>:</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [1 0]                                      ::  just 0
  [ 8                                        ::  push
    [ 1                                      ::  quid
      [ 6                                    ::  pick
        [5 [4 0 6] [0 7]]                    ::  same (bump /6) /7
        [0 6]                                ::  /6
        [9 2 [0 2] [4 0 6] [0 7]]            ::  call.2 (cons /2 bump /6 /7)
      ]                                      :: 
    ]                                        :: 
    [9 2 0 1]                                ::  call.2 /1
  ]                                          ::
]                                            :: 
</pre></div></div>
<p>Seems to work nicely:</p>
<div class="code"><div class="highlight"><pre>: /~tomsyt-balsen/try/6/bin/dec/hoon
~tomsyt-balsen/try=&gt; :dec 42
41
</pre></div></div>
<p>Of course, there are limits:</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; :dec 0
</pre></div></div>
<p>You’ll have to hit <code>C</code>, and you’ll see a big ugly error stack.<span class="intersentencespace"></span> Nock can work wonders but it can’t decrement 0.<span class="intersentencespace"></span> (Yes, you can
build signed integers in Hoon - they are represented as atoms
with the sign bit low.)</p>
<div id="uid41" data-tralics-id="uid41" class="subsection" data-number="5.2.1"><h3><a href="ch3_cores_fragment.html#uid41" class="heading hyperref"><span class="number">5.2.1 </span>A function</a></h3>
<p>As we start to build up toward language-level primitives, it
behooves us to do things the way a higher-level language would do
them.<span class="intersentencespace"></span> Well, more exactly, the way Hoon does things.</p>
<p>Surprisingly, although a formula defines a function of the
subject, a function - at the language level - is not the same
thing as a formula.<span class="intersentencespace"></span> Or rather, the argument is not the same
thing as the subject.</p>
<p>For instance, as we saw in decrement, the subject for the loop
needs to contain the code itself.<span class="intersentencespace"></span> If we apply a formula which
can’t call back into itself, our ability to loop is sorely
diminished.<span class="intersentencespace"></span> So at the very least, when we call a function,
the subject can’t just be <code>argument</code> - it has to be the cell
<code>[formula argument]</code>, so that the function can recurse.</p>
<p>Actually, it’s confusing to say <code>argument</code>, because this implies
a special status for single and multiple arguments.<span class="intersentencespace"></span> In Nock and
Hoon, we say <code>sample</code>, which is always one thing, but can be a
cell for “functions of two arguments”, a triple for three, etc.<span class="intersentencespace"></span> Eg, the sample for a decrement function is an atom; the sample
for an add function is a cell of two atoms; etc.</p>
<p>Furthermore, a function needs more data than just the argument -
it might, for instance, want to call other functions.<span class="intersentencespace"></span> Where’s it
going to get them?<span class="intersentencespace"></span> There is no external environment in Nock.</p>
<p>So the standard convention for a Nock function - or a Hoon
function - is</p>
<div class="code"><div class="highlight"><pre>[formula sample context]
</pre></div></div>
<p>Where <code>formula</code> is the code, <code>sample</code> is the argument(s), and
<code>context</code> is any other data and/or code that may be useful.</p>
<p>It’s a bit irregular that we are taking the external subject
and using it directly from our formula.<span class="intersentencespace"></span> Let’s try to build a
function with this convention and call it directly.</p>
<p>First, we’ll build an increment function to keep things simple.<span class="intersentencespace"></span> We actually don’t need anything in the context, so we’ll put 0.</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [                                          ::  cons
    [1 [4 0 6]]                              ::  quid bump /6  ::  formula
    [1 0]                                    ::  just 0        ::  sample
    [1 0]                                    ::  just 0        ::  context
  ]                                          ::  
  [ 9                                        ::  call
    2                                        ::  .2
    [0 4] [0 3] [0 11]                       ::  cons /4 /3 /11
  ]                                          ::  
]                                            ::
</pre></div></div>
<p>Why <code>[[0 4] [0 3] [0 11]]</code>?<span class="intersentencespace"></span> Our goal in calling the function is
to take the blank default core we’ve created at <code>/2</code>, and
substitute in the original subject of the outer formula, which
before the outer <code>8</code> was <code>/1</code> and is now <code>/3</code>.<span class="intersentencespace"></span> Around this
we wrap the formula from the default core, at <code>/4</code>, and the
(dummy) context, at <code>/11</code> - that is, <code>/7</code> within <code>/2</code>.</p>
<p>Let’s fit our decrement into this framework:</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [                                          ::  cons
    [ 1                                      ::  quid    ::  formula
      [ 8                                    ::  push
        [1 0]                                ::  just 0
        [ 8                                  ::  push
          [ 1                                ::  quid
            [ 6                              ::  pick
              [5 [4 0 6] [0 30]]             ::  same /6 /30
              [0 6]                          ::  /6
              [9 2 [0 2] [4 0 6] [0 7]]      ::  call.2 /2 (bump /6) /11
            ]                                ::
          ]                                  ::
          [9 2 0 1]                          ::  call.2 /1
        ]                                    ::
      ]                                      ::
    ]                                        ::
    [1 0]                                    ::  just 0  ::  sample
    [1 0]                                    ::  just 0  ::  context
  ]                                          ::
  [9 2 [0 4] [0 3] [0 11]]                   ::  call.2 /4 /3 /11
]                                            ::
</pre></div></div>
<p>Observe that nothing has changed from the way we called our
increment function, and only one thing has changed within the
decrement formula - the axis of the argument.<span class="intersentencespace"></span> Now at <code>/7</code> is not
the naked argument to decrement, but our outer core.<span class="intersentencespace"></span> The sample
is at <code>/6</code> within this <code>/7</code>, ie, at <code>/30</code>.</p>
</div></div>
<div id="cid19" data-tralics-id="cid19" class="section" data-number="5.3"><h2><a href="ch3_cores_fragment.html#cid19" class="heading hyperref"><span class="number">5.3 </span>A library</a></h2>
<p>Frankly, this is getting close to the limits of anything you’d
want to do in hand-generated Nock.<span class="intersentencespace"></span> But why not press on?</p>
<p>What we’d really like to do is build a library of functions that
can call each other.<span class="intersentencespace"></span> It’s easy to guess that this library will
be a core.<span class="intersentencespace"></span> But what does this core look like?</p>
<p>A function core, <code>[formula sample context]</code>, is a very useful
kind of core, but it’s not the only kind of core.<span class="intersentencespace"></span> (Actually,
because the word “function” is too easy to throw around, we have
a special name for a function core: we call it a <code>gate</code>.<span class="intersentencespace"></span> Compare
to “lambda” or “closure.”)</p>
<p>But in general, a core is just <code>[code data]</code> - or, to use more
lingo, <code>[battery payload]</code>.<span class="intersentencespace"></span> The payload can be anything - it’s
just data.</p>
<p>The battery can be one <em>or more</em> formulas, each of which is
applied with the core as its subject.<span class="intersentencespace"></span> This is why <code>9</code> takes the
axis operand <code>b</code>.<span class="intersentencespace"></span> If the core is a gate, the battery is just one
formula; this is the head of the core, so <code>b</code> is 2.</p>
<p>But not every core is a gate.<span class="intersentencespace"></span> Suppose we want to build a
library?<span class="intersentencespace"></span> We could assemble a bundle of cores and put it in
the context.<span class="intersentencespace"></span> So, let’s say we need to write subtract, which
obviously is going to use decrement.<span class="intersentencespace"></span> So, the context will be</p>
<div class="code"><div class="highlight"><pre>[subtract-gate decrement-gate]
</pre></div></div>
<p>But wait.<span class="intersentencespace"></span> Each gate is <code>[formula sample context]</code>.<span class="intersentencespace"></span> So, because
Nock doesn’t do cycles, there’s no way the subtract gate and the
decrement gate can each reference each other through the context.<span class="intersentencespace"></span> It happens to be the case here that subtract needs decrement, but
decrement doesn’t need subtract.<span class="intersentencespace"></span> But we’re not looking for ugly
at this point - we know Nock is more than capable of that.</p>
<p>To support general mutual recursion, our library needs to be a
battery in which each formula produces a gate.<span class="intersentencespace"></span> The context of
that gate is the library core.</p>
<p>Let’s repeat this again because it’s so important.<span class="intersentencespace"></span> Our library
will be a battery in which each formula produces a gate.<span class="intersentencespace"></span> The
context of that gate is the library core.</p>
<p>Let’s build a trivial library core of this form, with one
function, good old increment.<span class="intersentencespace"></span> Then, we’ll call it.</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [                                          ::  cons
    [ 1                                      ::  quid          ::  battery
      [1 [4 0 6]]                            ::  quid bump /6
      [1 0]                                  ::  just 0
      [0 1]                                  ::  /1
    ]                                        ::
    [1 0]                                    ::  just 0        ::  payload
  ]                                          ::  
  [ 8                                        ::  push
    [9 2 0 2]                                ::  call.2 /2
    [9 2 [0 4] [0 7] [0 11]]                 ::  call.2 /4 /7 /11
  ]                                          ::
]                                            ::
</pre></div></div>
<p>Compare this to the standalone increment above.<span class="intersentencespace"></span> It’s obviously
more complex and it should be.</p>
<p>First of all, what we put in the library core is not the function
gate directly, but a formula that generates the gate.<span class="intersentencespace"></span> This way,
and only this way, we can put the library itself in the context.</p>
<p>Second, what’s the payload of the library core?<span class="intersentencespace"></span> It’s <code>0</code>,
because the library doesn’t depend on anything.<span class="intersentencespace"></span> It certainly
doesn’t depend on the argument to our application.</p>
<p>Third, now we can’t just call the gate directly.<span class="intersentencespace"></span> We have to
actually build it.<span class="intersentencespace"></span> So we need another <code>8</code> to “push it on the
stack”, and then we call it with the usual <code>9</code>.<span class="intersentencespace"></span> Since the
subject at this point is <code>[gate library argument]</code>, the sample we
use is <code>[0 7]</code> rather than <code>[0 3]</code> - everything else is the same.</p>
<p>But does it work?<span class="intersentencespace"></span> C’mon, you know it works:</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; :dec 42
43
</pre></div></div>
<p>Okay, let’s go ahead and put our actual decrement function in
the library.</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [                                          ::  cons
    [ 1                                      ::  quid     :: formula
      [ 1                                    ::  quid     :: decrement
        [ 8                                  ::  push
          [1 0]                              ::  just 0
          [ 8                                ::  push dec
            [ 1                              ::  quid
              [ 6                            ::  pick
                [5 [4 0 6] [0 30]]           ::  same (bump /6) /30
                [0 6]                        ::  /6
                [9 2 [0 2] [4 0 6] [0 7]]    ::  call.2 /2 (bump /6) /7
              ]                              ::
            ]                                :: 
            [9 2 0 1]                        ::  call .2 /1
          ]                                  ::
        ]                                    ::
      ]                                      ::
      [1 0]                                  ::  just 0   :: sample
      [0 1]                                  ::  /1       :: context
    ]                                        ::
    [1 0]                                    ::  just 0   :: payload
  ]                                          ::
  [ 8                                        ::  push
    [9 2 0 2]                                ::  call.2 /2
    [ 9                                      ::  call
      2                                      ::  .2
      [0 4] [0 7] [0 11]                     ::  /4 /7 /11
    ]                                        ::
  ]                                          ::
]                                            ::
                  
~tomsyt-balsen/try=&gt; :dec 42
43
</pre></div></div>
<p>Then, let’s go crazy and add a subtract function, which calls
decrement.</p>
<div class="code"><div class="highlight"><pre>[ 8                                          ::  push
  [                                          ::  cons
    [                                        ::  cons
      [ 1                                    ::  quid       :: subtract
        [ 1                                  ::  quid       :: formula
          [ 8                                ::  push
            [9 5 0 7]                        ::  call.5 /7
            [ 6                              ::  pick
              [5 [1 0] [0 29]]               ::  same just 0 /29
              [0 28]                         ::  /29
              [ 9                            ::  call
                2                            ::  .2
                [0 6]                        ::  /6
                [ [9 2 [0 4] [0 28] [0 15]]  ::  call .2 /4 /28 /15
                  [9 2 [0 4] [0 29] [0 15]]  ::  call .2 /4 /29 /15
                ]                            ::
                [0 15]                       ::  /15
              ]                              ::
            ]                                ::
          ]                                  ::
        ]                                    ::
        [1 0]                                ::  just 0    ::  sample
        [0 1]                                ::  /1        ::  context
      ]                                      :: 
      [ 1                                    ::  quid      :: decrement
        [ 1                                  ::  quid      :: formula
          [ 8                                ::  push
            [1 0]                            ::  just 0
            [ 8                              ::  push
              [ 1                            ::  quid
                [ 6                          ::  pick
                  [5 [4 0 6] [0 30]]         ::  same bump /6 /30
                  [0 6]                      ::  /6
                  [9 2 [0 2] [4 0 6] [0 7]]  ::  call.2 /2 (bump /6) /7
                ]                            ::
              ]                              ::
              [9 2 0 1]                      ::  call.2 /1
            ]                                ::
          ]                                  ::
        ]                                    ::
        [1 0]                                ::  just 0
        [0 1]                                ::  /1
      ]                                      ::
    ]                                        ::
    [1 0]                                    ::  just 0    :: payload
  ]                                          :: 
  [ 8                                        ::  push
    [9 4 0 2]                                ::  call.4 /2
    [ 9                                      ::  call
      2                                      ::  .2
      [0 4] [0 7] [0 11]                     ::  /4 /7 /11
    ]                                        ::
  ]                                          ::
]
</pre></div></div>
<p>Note that the call to build the gate is <code>[9 4 0 2]</code>, because the
subtract arm is the head of the battery, which is the head of the
core - ie, <code>/2</code> within <code>/2</code> - ie, <code>/4</code>.</p>
<p>Does this work?<span class="intersentencespace"></span> Really?</p>
<div class="code"><div class="highlight"><pre>~tomsyt-balsen/try=&gt; :dec [42 12]
30
</pre></div></div>
<p>##Exercises##</p>
<p>Do you actually know Nock now?<span class="intersentencespace"></span> Well, possibly.</p>
<p>A good exercise is to add more simple math functions to this
battery.<span class="intersentencespace"></span> Try add, multiply, and divide.<span class="intersentencespace"></span> One way to start is by
walking through the routines above and figuring out what they’re doing.</p>
<p>Computing axes is slightly arduous (which is why we use Hoon,
generally).<span class="intersentencespace"></span> We are torturing ourselves by using Nock, but we
might as well use Hoon to calculate axes:</p>
<div class="code"><div class="highlight"><pre>    ~tomsyt-balsen/try=&gt; (peg 3 3)
    7
    ~tomsyt-balsen/try=&gt; (peg 3 5)
    13
</pre></div></div>
<p>Ie, <code>(peg a b)</code> is <code>/b</code> within <code>/a</code>.<span class="intersentencespace"></span> Writing Nock without this
would be pretty tough.</p>
</div>
    </div>
  </body>
</html>
